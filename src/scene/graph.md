# Граф (Graph)

Граф — это набор объектов с иерархическими отношениями между каждым объектом. Это одна из самых важных сущностей в движке. Граф заботится о ваших объектах сцены и выполняет всю тяжёлую работу за вас.

## Как создать граф

Вам не нужно создавать граф вручную, каждая сцена имеет свой собственный экземпляр графа. К нему можно легко получить доступ: `scene_ref.graph`.

## Добавление узлов

Есть два способа добавления узлов в граф: с использованием _конструкторов узлов_ или вручную, вызывая `graph.add_node`.

### Использование конструкторов узлов

Каждый узел в движке имеет свой соответствующий конструктор, который можно использовать для создания экземпляра узла. Использование конструкторов — это предпочтительный способ создания узлов сцены. Существуют следующие конструкторы узлов:

1) `BaseBuilder` — создаёт экземпляр базового узла. См. [Базовый узел](./base_node.md) для получения дополнительной информации.
2) `PivotBuilder` — создаёт экземпляр узла-опоры. См. [Базовый узел](./base_node.md) для получения дополнительной информации.
3) `CameraBuilder` — создаёт экземпляр узла камеры. См. [Узел камеры](./camera_node.md) для получения дополнительной информации.
4) `MeshBuilder` — создаёт экземпляр узла модели. См. [Узел модели](./mesh_node.md) для получения дополнительной информации.
5) `LightBuilder` — создаёт экземпляр узла света. См. [Узел света](./light_node.md) для получения дополнительной информации.
6) `SpriteBuilder` — создаёт экземпляр узла спрайта. См. [Узел спрайта](./sprite_node.md) для получения дополнительной информации.
7) `ParticleSystemBuilder` — создаёт экземпляр узла системы частиц. См. [Узел системы частиц](./particle_system_node.md) для получения дополнительной информации.
8) `TerrainBuilder` — создаёт экземпляр узла ландшафта. См. [Узел ландшафта](./terrain_node.md) для получения дополнительной информации.
9) `DecalBuilder` — создаёт экземпляр узла декали. См. [Узел декали](./decal_node.md) для получения дополнительной информации.
10) `RigidBody` — создаёт экземпляр узла твёрдого тела. См. [Твёрдое тело](../physics/rigid_body.md) для получения дополнительной информации.
11) `Collider` — создаёт экземпляр узла коллайдера. См. [Коллайдер](../physics/collider.md) для получения дополнительной информации.
12) `Joint` — создаёт экземпляр узла соединения. См. [Соединение](../physics/joint.md) для получения дополнительной информации.
13) `Rectangle` — создаёт экземпляр 2D узла прямоугольника. См. [Прямоугольник](./rectangle.md) для получения дополнительной информации.

Каждый конструктор, кроме `BaseBuilder`, принимает `BaseBuilder` в качестве параметра в методе `.new(..)`. Почему так? Потому что каждый узел (кроме базового) "наследуется" от базового через композицию, и производный конструктор должен знать, как построить базовый узел. Хотя это может звучать запутанно, на самом деле это очень полезно и понятно. Рассмотрим этот пример:

```rust,no_run
{{#include ../code/snippets/src/scene/graph.rs:create_camera}}
```

Как видите, мы создаём экземпляр `BaseBuilder` и заполняем его желаемыми свойствами, а также заполняем свойства экземпляра `CameraBuilder`. Это очень гибкий механизм, позволяющий вам создавать сложные иерархии в декларативной манере:

```rust,no_run
{{#include ../code/snippets/src/scene/graph.rs:create_node}}
```

Этот фрагмент кода создаёт камеру для игрока в ролевой игре от первого лица, в правой руке у него будет посох и заклинание в левой руке. Конечно, всё это очень упрощено, но должно дать вам основную идею. Обратите внимание, что посох и огненный шар будут дочерними узлами камеры, и при установке их трансформации мы фактически устанавливаем **локальную** трансформацию, что означает, что трансформация будет относительной к камере. Посох и заклинание будут премещаться вместе с камерой.

### Добавление узла вручную

Возможно, в некоторых редких случаях вы захотите отложить добавление узла в граф, специально для этой цели каждый конструктор узлов имеет метод `.build_node`, который создаёт экземпляр `Node`, но не добавляет его в граф.

```rust,no_run
{{#include ../code/snippets/src/scene/graph.rs:create_node_manually}}
```

## Как изменить иерархию

Во многих случаях вы не можете использовать конструкторы для создания сложной иерархии, простейший пример такой ситуации — когда вы создаёте экземпляр какой-то 3D-модели. Если вы хотите, чтобы экземпляр был дочерним объектом какого-то другого объекта, вы должны явно прикрепить его, используя `graph.link_nodes(..)`:

```rust,no_run
{{#include ../code/snippets/src/scene/graph.rs:link_weapon_to_camera}}
```

Здесь мы загрузили 3D-модель оружия, инстанцировали её на сцене и прикрепили к _существующей_ камере.

## Как удалить узлы

Узел можно удалить, просто вызвав `graph.remove_node(handle)`, этот метод удаляет узел из графа **со всеми его дочерними узлами**. Иногда это нежелательное поведение, и вы хотите сохранить дочерние узлы при удалении родительского узла. Для этого вам нужно явно отсоединить дочерние узлы узла, который вы собираетесь удалить:

```rust,no_run
{{#include ../code/snippets/src/scene/graph.rs:remove_preserve_children}}
```

После вызова этой функции каждый дочерний узел `node_to_remove` будет отсоединён от него, а `node_to_remove` будет удалён. `remove_node` имеет некоторые ограничения: его нельзя использовать для извлечения "подграфа" из графа, он просто сразу удаляет узлы.